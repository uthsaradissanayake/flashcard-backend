(function(l,p){typeof exports=="object"&&typeof module!="undefined"?p(exports,require("seedrandom")):typeof define=="function"&&define.amd?define(["exports","seedrandom"],p):(l=typeof globalThis!="undefined"?globalThis:l||self,p(l.FSRS={},l.seedrandom))})(this,function(l,p){"use strict";var d=(a=>(a[a.New=0]="New",a[a.Learning=1]="Learning",a[a.Review=2]="Review",a[a.Relearning=3]="Relearning",a))(d||{}),n=(a=>(a[a.Manual=0]="Manual",a[a.Again=1]="Again",a[a.Hard=2]="Hard",a[a.Good=3]="Good",a[a.Easy=4]="Easy",a))(n||{});Date.prototype.scheduler=function(a,e){return y(this,a,e)},Date.prototype.diff=function(a,e){return P(this,a,e)},Date.prototype.format=function(){return D(this)},Date.prototype.dueFormat=function(a,e,t){return F(this,a,e,t)};function y(a,e,t){return new Date(t?f(a).getTime()+e*24*60*60*1e3:f(a).getTime()+e*60*1e3)}function P(a,e,t){if(!a||!e)throw new Error("Invalid date");const r=f(a).getTime()-f(e).getTime();let s=0;switch(t){case"days":s=Math.floor(r/(24*60*60*1e3));break;case"minutes":s=Math.floor(r/(60*1e3));break}return s}function D(a){const e=f(a),t=e.getFullYear(),r=e.getMonth()+1,s=e.getDate(),i=e.getHours(),o=e.getMinutes(),u=e.getSeconds();return`${t}-${g(r)}-${g(s)} ${g(i)}:${g(o)}:${g(u)}`}function g(a){return a<10?`0${a}`:`${a}`}const b=[60,60,24,31,12],M=["second","min","hour","day","month","year"];function F(a,e,t,r=M){a=f(a),e=f(e),r.length!==M.length&&(r=M);let s=a.getTime()-e.getTime(),i;for(s/=1e3,i=0;i<b.length&&!(s<b[i]);i++)s/=b[i];return`${Math.floor(s)}${t?r[i]:""}`}function f(a){if(typeof a=="object"&&a instanceof Date)return a;if(typeof a=="string"){const e=Date.parse(a);if(isNaN(e))throw new Error(`Invalid date:[${a}]`);return new Date(e)}else if(typeof a=="number")return new Date(a);throw new Error(`Invalid date:[${a}]`)}function w(a){if(typeof a=="string"){const e=a.charAt(0).toUpperCase(),t=a.slice(1).toLowerCase(),r=d[`${e}${t}`];if(r===void 0)throw new Error(`Invalid state:[${a}]`);return r}else if(typeof a=="number")return a;throw new Error(`Invalid state:[${a}]`)}function z(a){if(typeof a=="string"){const e=a.charAt(0).toUpperCase(),t=a.slice(1).toLowerCase(),r=n[`${e}${t}`];if(r===void 0)throw new Error(`Invalid rating:[${a}]`);return r}else if(typeof a=="number")return a;throw new Error(`Invalid rating:[${a}]`)}const U=[n.Again,n.Hard,n.Good,n.Easy],V=[{start:2.5,end:7,factor:.15},{start:7,end:20,factor:.1},{start:20,end:1/0,factor:.05}];function A(a,e,t){let r=1;for(const o of V)r+=o.factor*Math.max(Math.min(a,o.end)-o.start,0);a=Math.min(a,t);let s=Math.max(2,Math.round(a-r));const i=Math.min(Math.round(a+r),t);return a>e&&(s=Math.max(s,e+1)),s=Math.min(s,i),{min_ivl:s,max_ivl:i}}var B=Object.defineProperty,C=Object.getOwnPropertySymbols,J=Object.prototype.hasOwnProperty,K=Object.prototype.propertyIsEnumerable,x=(a,e,t)=>e in a?B(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,Q=(a,e)=>{for(var t in e||(e={}))J.call(e,t)&&x(a,t,e[t]);if(C)for(var t of C(e))K.call(e,t)&&x(a,t,e[t]);return a},_=(a,e,t)=>(x(a,typeof e!="symbol"?e+"":e,t),t);class O{constructor(e,t){_(this,"again"),_(this,"hard"),_(this,"good"),_(this,"easy"),_(this,"last_review"),_(this,"last_elapsed_days"),this.last_review=e.last_review||e.due,this.last_elapsed_days=e.elapsed_days,e.elapsed_days=e.state===d.New?0:t.diff(e.last_review,"days"),e.last_review=t,e.reps+=1,this.again=this.copy(e),this.hard=this.copy(e),this.good=this.copy(e),this.easy=this.copy(e)}copy(e){return Q({},e)}update_state(e){return e===d.New?(this.again.state=d.Learning,this.hard.state=d.Learning,this.good.state=d.Learning,this.easy.state=d.Review):e===d.Learning||e===d.Relearning?(this.again.state=e,this.hard.state=e,this.good.state=d.Review,this.easy.state=d.Review):e===d.Review&&(this.again.state=d.Relearning,this.hard.state=d.Review,this.good.state=d.Review,this.easy.state=d.Review,this.again.lapses+=1),this}schedule(e,t,r,s){return this.again.scheduled_days=0,this.hard.scheduled_days=t,this.good.scheduled_days=r,this.easy.scheduled_days=s,this.again.due=y(e,5),this.hard.due=t>0?y(e,t,!0):y(e,10),this.good.due=y(e,r,!0),this.easy.due=y(e,s,!0),this}record_log(e,t){return{[n.Again]:{card:this.again,log:{rating:n.Again,state:e.state,due:this.last_review,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:e.scheduled_days,review:t}},[n.Hard]:{card:this.hard,log:{rating:n.Hard,state:e.state,due:this.last_review,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:e.scheduled_days,review:t}},[n.Good]:{card:this.good,log:{rating:n.Good,state:e.state,due:this.last_review,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:e.scheduled_days,review:t}},[n.Easy]:{card:this.easy,log:{rating:n.Easy,state:e.state,due:this.last_review,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:e.scheduled_days,review:t}}}}}const H=.9,j=36500,L=[.5701,1.4436,4.1386,10.9355,5.1443,1.2006,.8627,.0362,1.629,.1342,1.0166,2.1174,.0839,.3204,1.4676,.219,2.8237],N=!1,W="3.5.7",R=a=>({request_retention:(a==null?void 0:a.request_retention)||H,maximum_interval:(a==null?void 0:a.maximum_interval)||j,w:(a==null?void 0:a.w)||L,enable_fuzz:(a==null?void 0:a.enable_fuzz)||N});function X(a,e){const t={due:a?f(a):new Date,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:0,lapses:0,state:d.New,last_review:void 0};return e&&typeof e=="function"?e(t):t}var Z=Object.defineProperty,ee=(a,e,t)=>e in a?Z(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,$=(a,e,t)=>(ee(a,typeof e!="symbol"?e+"":e,t),t);const E=-.5,S=19/81;class G{constructor(e){$(this,"param"),$(this,"intervalModifier"),$(this,"seed"),this.param=new Proxy(R(e),this.params_handler_proxy()),this.intervalModifier=this.calculate_interval_modifier(this.param.request_retention)}get interval_modifier(){return this.intervalModifier}calculate_interval_modifier(e){if(e<=0||e>1)throw new Error("Requested retention rate should be in the range (0,1]");return+((Math.pow(e,1/E)-1)/S).toFixed(8)}get parameters(){return this.param}set parameters(e){this.update_parameters(e)}params_handler_proxy(){const e=this;return{set:function(t,r,s){return r==="request_retention"&&Number.isFinite(s)&&(e.intervalModifier=e.calculate_interval_modifier(Number(s))),t[r]=s,!0}}}update_parameters(e){const t=R(e);for(const r in t)if(r in this.param){const s=r;this.param[s]=t[s]}}init_ds(e){e.again.difficulty=this.init_difficulty(n.Again),e.again.stability=this.init_stability(n.Again),e.hard.difficulty=this.init_difficulty(n.Hard),e.hard.stability=this.init_stability(n.Hard),e.good.difficulty=this.init_difficulty(n.Good),e.good.stability=this.init_stability(n.Good),e.easy.difficulty=this.init_difficulty(n.Easy),e.easy.stability=this.init_stability(n.Easy)}next_ds(e,t,r,s){e.again.difficulty=this.next_difficulty(t,n.Again),e.again.stability=this.next_forget_stability(t,r,s),e.hard.difficulty=this.next_difficulty(t,n.Hard),e.hard.stability=this.next_recall_stability(t,r,s,n.Hard),e.good.difficulty=this.next_difficulty(t,n.Good),e.good.stability=this.next_recall_stability(t,r,s,n.Good),e.easy.difficulty=this.next_difficulty(t,n.Easy),e.easy.stability=this.next_recall_stability(t,r,s,n.Easy)}init_stability(e){return Math.max(this.param.w[e-1],.1)}init_difficulty(e){return+Math.min(Math.max(this.param.w[4]-(e-3)*this.param.w[5],1),10).toFixed(8)}apply_fuzz(e,t,r){if(!r||e<2.5)return Math.round(e);const s=p(this.seed)(),{min_ivl:i,max_ivl:o}=A(e,t,this.param.maximum_interval);return Math.floor(s*(o-i+1)+i)}next_interval(e,t,r=this.param.enable_fuzz){const s=Math.min(Math.max(1,Math.round(e*this.intervalModifier)),this.param.maximum_interval);return this.apply_fuzz(s,t,r)}next_difficulty(e,t){const r=e-this.param.w[6]*(t-3);return this.constrain_difficulty(this.mean_reversion(this.param.w[4],r))}constrain_difficulty(e){return Math.min(Math.max(+e.toFixed(8),1),10)}mean_reversion(e,t){return+(this.param.w[7]*e+(1-this.param.w[7])*t).toFixed(8)}next_recall_stability(e,t,r,s){const i=n.Hard===s?this.param.w[15]:1,o=n.Easy===s?this.param.w[16]:1;return+(t*(1+Math.exp(this.param.w[8])*(11-e)*Math.pow(t,-this.param.w[9])*(Math.exp((1-r)*this.param.w[10])-1)*i*o)).toFixed(8)}next_forget_stability(e,t,r){return+(this.param.w[11]*Math.pow(e,-this.param.w[12])*(Math.pow(t+1,this.param.w[13])-1)*Math.exp((1-r)*this.param.w[14])).toFixed(8)}forgetting_curve(e,t){return+Math.pow(1+S*e/t,E).toFixed(8)}}var te=Object.defineProperty,ae=Object.defineProperties,ie=Object.getOwnPropertyDescriptors,T=Object.getOwnPropertySymbols,se=Object.prototype.hasOwnProperty,re=Object.prototype.propertyIsEnumerable,I=(a,e,t)=>e in a?te(a,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):a[e]=t,m=(a,e)=>{for(var t in e||(e={}))se.call(e,t)&&I(a,t,e[t]);if(T)for(var t of T(e))re.call(e,t)&&I(a,t,e[t]);return a},v=(a,e)=>ae(a,ie(e));class k extends G{constructor(e){super(e)}preProcessCard(e){return v(m({},e),{state:w(e.state),due:f(e.due),last_review:e.last_review?f(e.last_review):void 0})}preProcessDate(e){return f(e)}preProcessLog(e){return v(m({},e),{due:f(e.due),rating:z(e.rating),state:w(e.state),review:f(e.review)})}repeat(e,t,r){const s=this.preProcessCard(e);t=this.preProcessDate(t);const i=new O(s,t).update_state(s.state);this.seed=String(t.getTime())+String(s.reps);let o,u,h;const c=s.elapsed_days;switch(s.state){case d.New:this.init_ds(i),i.again.due=t.scheduler(1),i.hard.due=t.scheduler(5),i.good.due=t.scheduler(10),o=this.next_interval(i.easy.stability,c),i.easy.scheduled_days=o,i.easy.due=t.scheduler(o,!0);break;case d.Learning:case d.Relearning:h=0,u=this.next_interval(i.good.stability,c),o=Math.max(this.next_interval(i.easy.stability,c),u+1),i.schedule(t,h,u,o);break;case d.Review:{const de=s.difficulty,Y=s.stability,le=this.forgetting_curve(c,Y);this.next_ds(i,de,Y,le),h=this.next_interval(i.hard.stability,c),u=this.next_interval(i.good.stability,c),h=Math.min(h,u),u=Math.max(u,h+1),o=Math.max(this.next_interval(i.easy.stability,c),u+1),i.schedule(t,h,u,o);break}}const q=i.record_log(s,t);return r&&typeof r=="function"?r(q):q}get_retrievability(e,t,r=!0){const s=this.preProcessCard(e);if(t=this.preProcessDate(t),s.state!==d.Review)return;const i=Math.max(t.diff(s.last_review,"days"),0),o=this.forgetting_curve(i,Math.round(s.stability));return r?`${(o*100).toFixed(2)}%`:o}rollback(e,t,r){const s=this.preProcessCard(e),i=this.preProcessLog(t);if(i.rating===n.Manual)throw new Error("Cannot rollback a manual rating");let o,u,h;switch(i.state){case d.New:o=i.due,u=void 0,h=0;break;case d.Learning:case d.Relearning:case d.Review:o=i.review,u=i.due,h=s.lapses-(i.rating===n.Again&&i.state===d.Review?1:0);break}const c=v(m({},s),{due:o,stability:i.stability,difficulty:i.difficulty,elapsed_days:i.last_elapsed_days,scheduled_days:i.scheduled_days,reps:Math.max(0,s.reps-1),lapses:Math.max(0,h),state:i.state,last_review:u});return r&&typeof r=="function"?r(c):c}forget(e,t,r=!1,s){const i=this.preProcessCard(e);t=this.preProcessDate(t);const o=i.state===d.New?0:t.diff(i.last_review,"days"),u={rating:n.Manual,state:i.state,due:i.due,stability:i.stability,difficulty:i.difficulty,elapsed_days:0,last_elapsed_days:i.elapsed_days,scheduled_days:o,review:t},h={card:v(m({},i),{due:t,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:r?0:i.reps,lapses:r?0:i.lapses,state:d.New,last_review:i.last_review}),log:u};return s&&typeof s=="function"?s(h):h}reschedule(e,t={}){var r;if(!Array.isArray(e))throw new Error("cards must be an array");const s=[];for(const i of e){if(w(i.state)!==d.Review||!i.last_review)continue;const o=Math.floor(i.scheduled_days),u=this.next_interval(+i.stability.toFixed(2),Math.round(i.elapsed_days),(r=t.enable_fuzz)!=null?r:!0);if(u===o||u===0)continue;const h=m({},i);h.scheduled_days=u;const c=y(h.last_review,u,!0);t.dateHandler&&typeof t.dateHandler=="function"?h.due=t.dateHandler(c):h.due=c,s.push(h)}return s}}const ne=a=>new k(a||{});l.DECAY=E,l.FACTOR=S,l.FSRS=k,l.FSRSAlgorithm=G,l.FSRSVersion=W,l.Grades=U,l.Rating=n,l.SchedulingCard=O,l.State=d,l.createEmptyCard=X,l.date_diff=P,l.date_scheduler=y,l.default_enable_fuzz=N,l.default_maximum_interval=j,l.default_request_retention=H,l.default_w=L,l.fixDate=f,l.fixRating=z,l.fixState=w,l.formatDate=D,l.fsrs=ne,l.generatorParameters=R,l.get_fuzz_range=A,l.show_diff_message=F});
//# sourceMappingURL=index.umd.js.map
