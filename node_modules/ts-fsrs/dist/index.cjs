"use strict";var G=require("seedrandom"),d=(t=>(t[t.New=0]="New",t[t.Learning=1]="Learning",t[t.Review=2]="Review",t[t.Relearning=3]="Relearning",t))(d||{}),n=(t=>(t[t.Manual=0]="Manual",t[t.Again=1]="Again",t[t.Hard=2]="Hard",t[t.Good=3]="Good",t[t.Easy=4]="Easy",t))(n||{});Date.prototype.scheduler=function(t,e){return f(this,t,e)},Date.prototype.diff=function(t,e){return M(this,t,e)},Date.prototype.format=function(){return R(this)},Date.prototype.dueFormat=function(t,e,a){return E(this,t,e,a)};function f(t,e,a){return new Date(a?h(t).getTime()+e*24*60*60*1e3:h(t).getTime()+e*60*1e3)}function M(t,e,a){if(!t||!e)throw new Error("Invalid date");const r=h(t).getTime()-h(e).getTime();let i=0;switch(a){case"days":i=Math.floor(r/(24*60*60*1e3));break;case"minutes":i=Math.floor(r/(60*1e3));break}return i}function R(t){const e=h(t),a=e.getFullYear(),r=e.getMonth()+1,i=e.getDate(),s=e.getHours(),l=e.getMinutes(),o=e.getSeconds();return`${a}-${y(r)}-${y(i)} ${y(s)}:${y(l)}:${y(o)}`}function y(t){return t<10?`0${t}`:`${t}`}const p=[60,60,24,31,12],g=["second","min","hour","day","month","year"];function E(t,e,a,r=g){t=h(t),e=h(e),r.length!==g.length&&(r=g);let i=t.getTime()-e.getTime(),s;for(i/=1e3,s=0;s<p.length&&!(i<p[s]);s++)i/=p[s];return`${Math.floor(i)}${a?r[s]:""}`}function h(t){if(typeof t=="object"&&t instanceof Date)return t;if(typeof t=="string"){const e=Date.parse(t);if(isNaN(e))throw new Error(`Invalid date:[${t}]`);return new Date(e)}else if(typeof t=="number")return new Date(t);throw new Error(`Invalid date:[${t}]`)}function _(t){if(typeof t=="string"){const e=t.charAt(0).toUpperCase(),a=t.slice(1).toLowerCase(),r=d[`${e}${a}`];if(r===void 0)throw new Error(`Invalid state:[${t}]`);return r}else if(typeof t=="number")return t;throw new Error(`Invalid state:[${t}]`)}function $(t){if(typeof t=="string"){const e=t.charAt(0).toUpperCase(),a=t.slice(1).toLowerCase(),r=n[`${e}${a}`];if(r===void 0)throw new Error(`Invalid rating:[${t}]`);return r}else if(typeof t=="number")return t;throw new Error(`Invalid rating:[${t}]`)}const k=[n.Again,n.Hard,n.Good,n.Easy],T=[{start:2.5,end:7,factor:.15},{start:7,end:20,factor:.1},{start:20,end:1/0,factor:.05}];function D(t,e,a){let r=1;for(const l of T)r+=l.factor*Math.max(Math.min(t,l.end)-l.start,0);t=Math.min(t,a);let i=Math.max(2,Math.round(t-r));const s=Math.min(Math.round(t+r),a);return t>e&&(i=Math.max(i,e+1)),i=Math.min(i,s),{min_ivl:i,max_ivl:s}}class S{again;hard;good;easy;last_review;last_elapsed_days;copy(e){return{...e}}constructor(e,a){this.last_review=e.last_review||e.due,this.last_elapsed_days=e.elapsed_days,e.elapsed_days=e.state===d.New?0:a.diff(e.last_review,"days"),e.last_review=a,e.reps+=1,this.again=this.copy(e),this.hard=this.copy(e),this.good=this.copy(e),this.easy=this.copy(e)}update_state(e){return e===d.New?(this.again.state=d.Learning,this.hard.state=d.Learning,this.good.state=d.Learning,this.easy.state=d.Review):e===d.Learning||e===d.Relearning?(this.again.state=e,this.hard.state=e,this.good.state=d.Review,this.easy.state=d.Review):e===d.Review&&(this.again.state=d.Relearning,this.hard.state=d.Review,this.good.state=d.Review,this.easy.state=d.Review,this.again.lapses+=1),this}schedule(e,a,r,i){return this.again.scheduled_days=0,this.hard.scheduled_days=a,this.good.scheduled_days=r,this.easy.scheduled_days=i,this.again.due=f(e,5),this.hard.due=a>0?f(e,a,!0):f(e,10),this.good.due=f(e,r,!0),this.easy.due=f(e,i,!0),this}record_log(e,a){return{[n.Again]:{card:this.again,log:{rating:n.Again,state:e.state,due:this.last_review,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:e.scheduled_days,review:a}},[n.Hard]:{card:this.hard,log:{rating:n.Hard,state:e.state,due:this.last_review,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:e.scheduled_days,review:a}},[n.Good]:{card:this.good,log:{rating:n.Good,state:e.state,due:this.last_review,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:e.scheduled_days,review:a}},[n.Easy]:{card:this.easy,log:{rating:n.Easy,state:e.state,due:this.last_review,stability:e.stability,difficulty:e.difficulty,elapsed_days:e.elapsed_days,last_elapsed_days:this.last_elapsed_days,scheduled_days:e.scheduled_days,review:a}}}}}const z=.9,F=36500,A=[.5701,1.4436,4.1386,10.9355,5.1443,1.2006,.8627,.0362,1.629,.1342,1.0166,2.1174,.0839,.3204,1.4676,.219,2.8237],C=!1,q="3.5.7",m=t=>({request_retention:(t==null?void 0:t.request_retention)||z,maximum_interval:(t==null?void 0:t.maximum_interval)||F,w:(t==null?void 0:t.w)||A,enable_fuzz:(t==null?void 0:t.enable_fuzz)||C});function I(t,e){const a={due:t?h(t):new Date,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:0,lapses:0,state:d.New,last_review:void 0};return e&&typeof e=="function"?e(a):a}const w=-.5,v=19/81;class H{param;intervalModifier;seed;constructor(e){this.param=new Proxy(m(e),this.params_handler_proxy()),this.intervalModifier=this.calculate_interval_modifier(this.param.request_retention)}get interval_modifier(){return this.intervalModifier}calculate_interval_modifier(e){if(e<=0||e>1)throw new Error("Requested retention rate should be in the range (0,1]");return+((Math.pow(e,1/w)-1)/v).toFixed(8)}get parameters(){return this.param}set parameters(e){this.update_parameters(e)}params_handler_proxy(){const e=this;return{set:function(a,r,i){return r==="request_retention"&&Number.isFinite(i)&&(e.intervalModifier=e.calculate_interval_modifier(Number(i))),a[r]=i,!0}}}update_parameters(e){const a=m(e);for(const r in a)if(r in this.param){const i=r;this.param[i]=a[i]}}init_ds(e){e.again.difficulty=this.init_difficulty(n.Again),e.again.stability=this.init_stability(n.Again),e.hard.difficulty=this.init_difficulty(n.Hard),e.hard.stability=this.init_stability(n.Hard),e.good.difficulty=this.init_difficulty(n.Good),e.good.stability=this.init_stability(n.Good),e.easy.difficulty=this.init_difficulty(n.Easy),e.easy.stability=this.init_stability(n.Easy)}next_ds(e,a,r,i){e.again.difficulty=this.next_difficulty(a,n.Again),e.again.stability=this.next_forget_stability(a,r,i),e.hard.difficulty=this.next_difficulty(a,n.Hard),e.hard.stability=this.next_recall_stability(a,r,i,n.Hard),e.good.difficulty=this.next_difficulty(a,n.Good),e.good.stability=this.next_recall_stability(a,r,i,n.Good),e.easy.difficulty=this.next_difficulty(a,n.Easy),e.easy.stability=this.next_recall_stability(a,r,i,n.Easy)}init_stability(e){return Math.max(this.param.w[e-1],.1)}init_difficulty(e){return+Math.min(Math.max(this.param.w[4]-(e-3)*this.param.w[5],1),10).toFixed(8)}apply_fuzz(e,a,r){if(!r||e<2.5)return Math.round(e);const i=G(this.seed)(),{min_ivl:s,max_ivl:l}=D(e,a,this.param.maximum_interval);return Math.floor(i*(l-s+1)+s)}next_interval(e,a,r=this.param.enable_fuzz){const i=Math.min(Math.max(1,Math.round(e*this.intervalModifier)),this.param.maximum_interval);return this.apply_fuzz(i,a,r)}next_difficulty(e,a){const r=e-this.param.w[6]*(a-3);return this.constrain_difficulty(this.mean_reversion(this.param.w[4],r))}constrain_difficulty(e){return Math.min(Math.max(+e.toFixed(8),1),10)}mean_reversion(e,a){return+(this.param.w[7]*e+(1-this.param.w[7])*a).toFixed(8)}next_recall_stability(e,a,r,i){const s=n.Hard===i?this.param.w[15]:1,l=n.Easy===i?this.param.w[16]:1;return+(a*(1+Math.exp(this.param.w[8])*(11-e)*Math.pow(a,-this.param.w[9])*(Math.exp((1-r)*this.param.w[10])-1)*s*l)).toFixed(8)}next_forget_stability(e,a,r){return+(this.param.w[11]*Math.pow(e,-this.param.w[12])*(Math.pow(a+1,this.param.w[13])-1)*Math.exp((1-r)*this.param.w[14])).toFixed(8)}forgetting_curve(e,a){return+Math.pow(1+v*e/a,w).toFixed(8)}}class P extends H{constructor(e){super(e)}preProcessCard(e){return{...e,state:_(e.state),due:h(e.due),last_review:e.last_review?h(e.last_review):void 0}}preProcessDate(e){return h(e)}preProcessLog(e){return{...e,due:h(e.due),rating:$(e.rating),state:_(e.state),review:h(e.review)}}repeat(e,a,r){const i=this.preProcessCard(e);a=this.preProcessDate(a);const s=new S(i,a).update_state(i.state);this.seed=String(a.getTime())+String(i.reps);let l,o,u;const c=i.elapsed_days;switch(i.state){case d.New:this.init_ds(s),s.again.due=a.scheduler(1),s.hard.due=a.scheduler(5),s.good.due=a.scheduler(10),l=this.next_interval(s.easy.stability,c),s.easy.scheduled_days=l,s.easy.due=a.scheduler(l,!0);break;case d.Learning:case d.Relearning:u=0,o=this.next_interval(s.good.stability,c),l=Math.max(this.next_interval(s.easy.stability,c),o+1),s.schedule(a,u,o,l);break;case d.Review:{const N=i.difficulty,x=i.stability,L=this.forgetting_curve(c,x);this.next_ds(s,N,x,L),u=this.next_interval(s.hard.stability,c),o=this.next_interval(s.good.stability,c),u=Math.min(u,o),o=Math.max(o,u+1),l=Math.max(this.next_interval(s.easy.stability,c),o+1),s.schedule(a,u,o,l);break}}const b=s.record_log(i,a);return r&&typeof r=="function"?r(b):b}get_retrievability(e,a,r=!0){const i=this.preProcessCard(e);if(a=this.preProcessDate(a),i.state!==d.Review)return;const s=Math.max(a.diff(i.last_review,"days"),0),l=this.forgetting_curve(s,Math.round(i.stability));return r?`${(l*100).toFixed(2)}%`:l}rollback(e,a,r){const i=this.preProcessCard(e),s=this.preProcessLog(a);if(s.rating===n.Manual)throw new Error("Cannot rollback a manual rating");let l,o,u;switch(s.state){case d.New:l=s.due,o=void 0,u=0;break;case d.Learning:case d.Relearning:case d.Review:l=s.review,o=s.due,u=i.lapses-(s.rating===n.Again&&s.state===d.Review?1:0);break}const c={...i,due:l,stability:s.stability,difficulty:s.difficulty,elapsed_days:s.last_elapsed_days,scheduled_days:s.scheduled_days,reps:Math.max(0,i.reps-1),lapses:Math.max(0,u),state:s.state,last_review:o};return r&&typeof r=="function"?r(c):c}forget(e,a,r=!1,i){const s=this.preProcessCard(e);a=this.preProcessDate(a);const l=s.state===d.New?0:a.diff(s.last_review,"days"),o={rating:n.Manual,state:s.state,due:s.due,stability:s.stability,difficulty:s.difficulty,elapsed_days:0,last_elapsed_days:s.elapsed_days,scheduled_days:l,review:a},u={card:{...s,due:a,stability:0,difficulty:0,elapsed_days:0,scheduled_days:0,reps:r?0:s.reps,lapses:r?0:s.lapses,state:d.New,last_review:s.last_review},log:o};return i&&typeof i=="function"?i(u):u}reschedule(e,a={}){if(!Array.isArray(e))throw new Error("cards must be an array");const r=[];for(const i of e){if(_(i.state)!==d.Review||!i.last_review)continue;const s=Math.floor(i.scheduled_days),l=this.next_interval(+i.stability.toFixed(2),Math.round(i.elapsed_days),a.enable_fuzz??!0);if(l===s||l===0)continue;const o={...i};o.scheduled_days=l;const u=f(o.last_review,l,!0);a.dateHandler&&typeof a.dateHandler=="function"?o.due=a.dateHandler(u):o.due=u,r.push(o)}return r}}const O=t=>new P(t||{});exports.DECAY=w,exports.FACTOR=v,exports.FSRS=P,exports.FSRSAlgorithm=H,exports.FSRSVersion=q,exports.Grades=k,exports.Rating=n,exports.SchedulingCard=S,exports.State=d,exports.createEmptyCard=I,exports.date_diff=M,exports.date_scheduler=f,exports.default_enable_fuzz=C,exports.default_maximum_interval=F,exports.default_request_retention=z,exports.default_w=A,exports.fixDate=h,exports.fixRating=$,exports.fixState=_,exports.formatDate=R,exports.fsrs=O,exports.generatorParameters=m,exports.get_fuzz_range=D,exports.show_diff_message=E,module.exports=Object.assign(exports.default||{},exports);
//# sourceMappingURL=index.cjs.map
